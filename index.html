<!doctype html>
<html lang="fr" data-build="fd17f59">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Journal Piscine</title>

  <!-- PWA / iPhone -->
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #0b1220; color: #e6eefc; overflow-x:hidden; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 14px; font-size: 22px; }
    .card { background: #121b2e; border: 1px solid #233055; border-radius: 14px; padding: 16px; margin-top: 14px; }

    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-12{ grid-column: span 12; }
    .col-6{ grid-column: span 6; }
    @media (max-width: 760px){
      .col-6{ grid-column: span 12; }
      .wrap{ padding: 14px; }
    }

    /* ‚úÖ Fix iOS overflow grid/input */
    .grid > div { min-width: 0; }
    input[type="date"] { min-width: 0; -webkit-appearance: none; appearance: none; }

    label { display:block; font-size: 12px; opacity: .9; margin-bottom: 6px; }
    input, button, select {
      width: 100%; max-width: 100%;
      box-sizing: border-box;
      background: #0c1427; color: #e6eefc;
      border: 1px solid #26365f; border-radius: 12px;
      padding: 12px; outline: none;
    }
    input:focus, select:focus { border-color: #4f7cff; }
    button { cursor: pointer; font-weight: 650; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    .btn { background: #4f7cff; border-color: #4f7cff; }
    .btn2 { background: #162243; }
    .danger { background: #ff4f6a; border-color: #ff4f6a; }

    .inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; background: #0c1427; border:1px solid #26365f; font-size: 12px; }
    .muted { opacity:.8; }

    .kpis { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
    @media (max-width: 760px){ .kpis { grid-template-columns: repeat(2, 1fr);} }
    .kpi { background: #0c1427; border: 1px solid #26365f; border-radius: 12px; padding: 12px; }
    .kpi .t { font-size: 12px; opacity: .85; }
    .kpi .v { font-size: 18px; font-weight: 750; margin-top: 4px; }
    .kpi .s { font-size: 12px; opacity:.8; margin-top: 4px; }

    .error { color: #ffb4bf; margin-top: 8px; }
    .success { color: #b7ffd2; margin-top: 8px; }

    /* ‚úÖ Tables responsive */
    .tablewrap { overflow-x: auto; border-radius: 12px; border: 1px solid #26365f; }
    table { width: 100%; border-collapse: collapse; min-width: 680px; }
    th, td { padding: 10px; border-bottom: 1px solid #243356; text-align: left; font-size: 13px; white-space: nowrap; }
    th { font-size: 12px; opacity: .9; background: #0c1427; position: sticky; top: 0; }
    tr:hover td { background: rgba(79,124,255,.06); }
    .right { text-align:right; }

    /* Charts */
    .chartBox { background: #0c1427; border: 1px solid #26365f; border-radius: 12px; padding: 12px; }
    canvas { width: 100%; height: 220px; display:block; }
    .small { font-size: 12px; opacity:.85; }

    /* Badges status */
    .pill.ok { border-color:#2ecc71; }
    .pill.warn { border-color:#f1c40f; }
    .pill.bad { border-color:#ff4f6a; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>üèä Journal Piscine</h1>

    <!-- ‚úÖ Point B: version inject√©e automatiquement -->
    <!--<div class="pill" id="uiBuildPill" style="margin-bottom:10px;">Version: a6e6a11</div> -->
	<div class="pill" id="uiBuildPill" style="margin-bottom:10px;">Version: fd17f59</div>
    <script>
     // On utilise des guillemets pour que a58a82e devienne une string apr√®s injection
 	 window.buildId = "fd17f59"; 
  	 document.documentElement.setAttribute("data-build", window.buildId);
    </script>

    <!-- Badges live HTML/SW -->
    <div class="inline" style="gap:8px; margin:10px 0;">
      <div class="pill" id="uiHtmlBuild">HTML: ‚Äî</div>
      <div class="pill" id="uiSwBuild">SW actif: ‚Äî</div>
      <div class="pill muted" id="uiSwState" style="display:none;">SW: update‚Ä¶</div>
    </div>
	
	<div class="card" style="margin-top:10px;">
		<div class="inline">
			<div class="pill" id="authState">Compte: ‚Äî</div>
			<div style="flex:1"></div>
			<button class="btn2" id="btnCloudReload" type="button">Recharger depuis le cloud</button>
			<button class="btn2" id="btnCloudPush" type="button">Envoyer le local ‚Üí cloud</button>
		</div>


		<div class="grid" style="margin-top:10px;">
			<div class="col-6">
				<label for="authEmail">Email</label>
				<input id="authEmail" type="email" placeholder="toi@email.com" />
			</div>
			<div class="col-6">
				<label for="authPass">Mot de passe</label>
				<input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
			</div>


			<div class="col-12 row">
				<button class="btn" id="btnSignUp" type="button">Cr√©er un compte</button>
				<button class="btn" id="btnSignIn" type="button">Se connecter</button>
				<button class="danger" id="btnSignOut" type="button">Se d√©connecter</button>
			</div>

			<div style="width: 100%; margin-top: 20px; text-align: center; border-top: 1px solid #233055; padding-top: 10px;">
			    <span style="color: #6c757d; font-size: 11px; display: block; line-height: 1.4;">
			        Une fois connect√©, tes sessions sont sauvegard√©es dans Supabase (accessible sur tous tes appareils).
			    </span>
			</div>
		</div>
	</div>

    <!-- FORM + HISTO KPIS -->
    <div class="card">
      <div class="grid">
        <div class="col-6">
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>

        <div class="col-6">
          <label for="poolLen">Taille d‚Äôune longueur (m√®tres)</label>
          <input id="poolLen" type="number" min="1" step="1" placeholder="25" />
        </div>

        <div class="col-6">
          <label for="laps">Nombre de longueurs</label>
          <input id="laps" type="number" min="0" step="1" placeholder="40" />
        </div>

        <div class="col-6">
          <label for="minutes">Temps de session (minutes)</label>
          <input id="minutes" type="number" min="0" step="0.1" placeholder="45" />
        </div>

        <div class="col-12">
          <label for="note">Note (optionnel)</label>
          <input id="note" type="text" placeholder="Ex: √©ducatifs, pull buoy, sensations..." />
        </div>

        <div class="col-6">
          <label for="weightKg">Poids (kg) pour kcal</label>
          <input id="weightKg" type="number" min="30" max="250" step="0.1" placeholder="70" />
        </div>

        <div class="col-6">
          <label for="intensity">Intensit√© nage (MET)</label>
          <select id="intensity">
            <option value="6">Facile (‚âà 6 MET)</option>
            <option value="8" selected>Mod√©r√© (‚âà 8 MET)</option>
            <option value="10">Soutenu (‚âà 10 MET)</option>
            <option value="12">Tr√®s soutenu (‚âà 12 MET)</option>
          </select>
        </div>

        <div class="col-12 row">
          <button class="btn" id="addBtn" type="button">Ajouter la session</button>
          <button class="btn2" id="forceBtn" type="button">Forcer la mise √† jour des stats</button>
          <button class="btn2" id="clearInputsBtn" type="button">Vider le formulaire</button>
          <button class="btn2" id="exportBtn" type="button">Exporter JSON</button>
          <button class="btn2" id="importBtn" type="button">Importer JSON</button>
          <button class="danger" id="wipeBtn" type="button">Tout effacer</button>
        </div>

        <div class="col-12">
          <div class="inline">
            <div class="pill">üìä Stats de l‚Äôhistorique</div>
            <div class="pill muted" id="activeKeyPill">storage: ‚Äî</div>
            <div style="flex:1"></div>
            <div class="muted" style="font-size:12px;">(pond√©r√©es par la distance)</div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="t">Distance totale</div>
              <div class="v" id="kDistance">‚Äî</div>
              <div class="s" id="kDistance2"></div>
            </div>
            <div class="kpi">
              <div class="t">Allure moyenne</div>
              <div class="v" id="kPace">‚Äî</div>
              <div class="s">min / 100 m</div>
            </div>
            <div class="kpi">
              <div class="t">Vitesse moyenne</div>
              <div class="v" id="kSpeed">‚Äî</div>
              <div class="s">km/h</div>
            </div>
            <div class="kpi">
              <div class="t">Cadence moyenne</div>
              <div class="v" id="kRate">‚Äî</div>
              <div class="s">m/min</div>
            </div>
          </div>

          <div class="kpis" style="margin-top:10px;">
            <div class="kpi">
              <div class="t">Temps total</div>
              <div class="v" id="kTime">‚Äî</div>
              <div class="s" id="kPeriod">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="t">kcal estim√©es (total)</div>
              <div class="v" id="kKcal">‚Äî</div>
              <div class="s small">MET √ó poids √ó dur√©e</div>
            </div>
            <div class="kpi">
              <div class="t">Record distance</div>
              <div class="v" id="kRecDist">‚Äî</div>
              <div class="s" id="kRecDist2"></div>
            </div>
            <div class="kpi">
              <div class="t">Record allure</div>
              <div class="v" id="kRecPace">‚Äî</div>
              <div class="s" id="kRecPace2"></div>
            </div>
          </div>

          <div class="error" id="msg"></div>
          <div class="success" id="msgOk"></div>
        </div>
      </div>
    </div>

    <!-- GRAPH + MONTHLY -->
    <div class="card">
      <div class="inline">
        <div class="pill">üìà Graphiques & stats mensuelles</div>
        <div style="flex:1"></div>
        <select id="chartRange">
          <option value="6">6 derniers mois</option>
          <option value="12" selected>12 derniers mois</option>
          <option value="24">24 derniers mois</option>
          <option value="all">Tout</option>
        </select>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="col-12 chartBox">
          <div class="inline">
            <div class="pill">Distance par mois (km)</div>
            <div style="flex:1"></div>
            <div class="muted small">barres</div>
          </div>
          <canvas id="chartMonthly"></canvas>
          <div class="muted small" id="chartMonthlyNote" style="margin-top:6px;"></div>
        </div>

        <div class="col-12 chartBox">
          <div class="inline">
            <div class="pill">Allure moyenne par mois (min/100m)</div>
            <div style="flex:1"></div>
            <div class="muted small">ligne</div>
          </div>
          <canvas id="chartPace"></canvas>
          <div class="muted small" id="chartPaceNote" style="margin-top:6px;"></div>
        </div>

        <div class="col-12">
          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th>Mois</th>
                  <th class="right">Sessions</th>
                  <th class="right">Distance</th>
                  <th class="right">Temps</th>
                  <th class="right">Allure moy.</th>
                  <th class="right">kcal</th>
                </tr>
              </thead>
              <tbody id="tbodyMonths"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- SESSIONS -->
    <div class="card">
      <div class="inline">
        <div class="pill" id="countPill">0 session</div>
        <div class="pill" id="sumPill">Total: 0 m</div>
        <div style="flex:1"></div>
        <select id="sort">
          <option value="date_desc">Trier: date (r√©cent ‚Üí ancien)</option>
          <option value="date_asc">Trier: date (ancien ‚Üí r√©cent)</option>
          <option value="dist_desc">Trier: distance (‚Üì)</option>
          <option value="time_desc">Trier: temps (‚Üì)</option>
          <option value="pace_asc">Trier: allure (rapide ‚Üí lent)</option>
        </select>
      </div>

      <div class="tablewrap" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>D√©tails</th>
              <th class="right">Distance</th>
              <th class="right">Temps</th>
              <th class="right">Allure</th>
              <th class="right">kcal</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      
		<div class="col-12 muted" style="font-size: 12px; margin-top: 8px; width: 100%; clear: both;">
    		Une fois connect√©, tes sessions sont sauvegard√©es dans Supabase (accessible sur tous tes appareils).
		</div>	
		
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- =========================
       SCRIPT PRINCIPAL APP
  ========================== -->
  <script>
    const $ = (id) => document.getElementById(id);
	
	// =========================
// SUPABASE INIT + AUTH
// =========================
const SUPABASE_URL = "https://arvmhuherwlizehvhptk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydm1odWhlcndsaXplaHZocHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzEzMjUsImV4cCI6MjA4NDk0NzMyNX0.MUVbwIMw9F0nhH1ZDjGfoPjNUDfweoL3oCEd-cuZJ4w";

// supabase-js v2 (CDN) expose un global `supabase`
// ‚ö†Ô∏è Important: on encapsule l'init pour ne pas casser toute l'app si Supabase est mal configur√©.
let sb = null;
try {
  const u = (SUPABASE_URL || "").trim();
  const k = (SUPABASE_ANON_KEY || "").trim();
  if (!/^https?:\/\//i.test(u)) throw new Error("SUPABASE_URL doit commencer par http(s)://");
  if (!k) throw new Error("SUPABASE_ANON_KEY manquante");
  sb = supabase.createClient(u, k);
} catch (e) {
  console.warn("Supabase init failed:", e);
  sb = null;
}
const authState = $("authState");
	const authEmail = $("authEmail");
	const authPass = $("authPass");
	const btnSignUp = $("btnSignUp");
	const btnSignIn = $("btnSignIn");
	const btnSignOut = $("btnSignOut");
	const btnCloudReload = $("btnCloudReload");
	const btnCloudPush = $("btnCloudPush");


	

function requireSupabase(){
  if (!sb) {
    alert("Supabase n‚Äôest pas initialis√© (v√©rifie SUPABASE_URL / ANON KEY et le chargement du CDN).");
    return false;
  }
  return true;
}
async function signUp(){
  <!-- if (!requireSupabase()) return; -->
	<!-- const email = (authEmail?.value || "").trim(); -->
	<!-- const password = (authPass?.value || "").trim(); -->
	<!-- if (!email || !password) return alert("Email + mot de passe requis."); -->


	<!-- const { error } = await sb.auth.signUp({ email, password }); -->
	<!-- if (error) return alert(error.message); -->


	<!-- alert("Compte cr√©√© ! V√©rifie tes emails si Supabase demande une confirmation."); -->
	const email = (authEmail?.value || "").trim();
	const password = (authPass?.value || "").trim();
	if (!email || !password) return alert("Email + mot de passe requis.");


	const redirectTo = new URL("./", window.location.href).href; // -> .../journal-piscine/


	const { error } = await sb.auth.signUp({
	email,
	password,
	options: { emailRedirectTo: redirectTo }
	});


	if (error) return alert(error.message);
	alert("Compte cr√©√© ! V√©rifie tes emails.");
	}

	(async () => {
		// Si Supabase renvoie ?code=... apr√®s validation
		const url = new URL(window.location.href);
		if (url.searchParams.get("code")) {
			await sb.auth.exchangeCodeForSession(window.location.href);
			// Nettoie l'URL (optionnel)
			url.searchParams.delete("code");
			window.history.replaceState({}, document.title, url.toString());
		}


		const { data } = await sb.auth.getSession();
		const user = data?.session?.user;
		authState.textContent = user ? `Compte: ${user.email}` : "Compte: ‚Äî";
	})();

	async function signIn(){
  if (!requireSupabase()) return;
		const email = (authEmail?.value || "").trim();
		const password = (authPass?.value || "").trim();
		if (!email || !password) return alert("Email + mot de passe requis.");


		const { error } = await sb.auth.signInWithPassword({ email, password });
		if (error) return alert(error.message);
	}


	async function signOut(){
  if (!requireSupabase()) return;
		const { error } = await sb.auth.signOut();
		if (error) alert(error.message);
	}


	// √©tat au chargement
	(async () => {
		const { data } = await sb.auth.getSession();
		const user = data?.session?.user;
		authState.textContent = user ? `Compte: ${user.email}` : "Compte: ‚Äî";
	})();


	// √©coute en live
	sb.auth.onAuthStateChange((_event, session) => {
		authState.textContent = session?.user ? `Compte: ${session.user.email}` : "Compte: ‚Äî";
	});


	// boutons
	if (btnSignUp) btnSignUp.onclick = signUp;
	if (btnSignIn) btnSignIn.onclick = signIn;
	if (btnSignOut) btnSignOut.onclick = signOut;


	// Pour l‚Äôinstant : on √©vite les erreurs si tu cliques.
	// On branchera vraiment la synchro cloud juste apr√®s.
	if (btnCloudReload) btnCloudReload.onclick = () => alert("√âtape suivante : lecture Supabase (cloud ‚Üí local).");
	if (btnCloudPush) btnCloudPush.onclick = () => alert("√âtape suivante : upload Supabase (local ‚Üí cloud).");
	

    // ‚úÖ support migration / anciennes versions
    const STORAGE_KEYS = ["swim_sessions_v1", "swim_sessions", "sessions_piscine"];
    let ACTIVE_KEY = null;

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function meters(laps, poolLen){
      return (Number(laps) || 0) * (Number(poolLen) || 0);
    }

    function paceMinPer100m(totalMeters, minutes){
      const m = Number(totalMeters);
      const t = Number(minutes);
      if (m <= 0 || t <= 0) return null;
      return t / (m / 100);
    }

    function formatPace(minPer100){
      if (minPer100 == null) return "‚Äî";
      const totalSeconds = Math.round(minPer100 * 60);
      const mm = Math.floor(totalSeconds / 60);
      const ss = String(totalSeconds % 60).padStart(2,"0");
      return `${mm}:${ss}`;
    }

    function speedKmh(totalMeters, minutes){
      const m = Number(totalMeters);
      const t = Number(minutes);
      if (m <= 0 || t <= 0) return null;
      return (m / 1000) / (t / 60);
    }

    function rateMPerMin(totalMeters, minutes){
      const m = Number(totalMeters);
      const t = Number(minutes);
      if (m <= 0 || t <= 0) return null;
      return m / t;
    }

    // kcal estimation (MET √ó kg √ó hours)
    function kcalFromMinutes(minutes){
      const met = Number($("intensity")?.value) || 8;
      const kg = Number($("weightKg")?.value) || 70;
      const hours = (Number(minutes) || 0) / 60;
      if (hours <= 0) return 0;
      return met * kg * hours;
    }

    function setMsg(err="", ok=""){
      $("msg").textContent = err;
      $("msgOk").textContent = ok;
    }

    function findActiveKey(){
      for (const k of STORAGE_KEYS){
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return k;
        } catch {}
      }
      return STORAGE_KEYS[0];
    }

    function normalizeSession(x){
      const poolLen = Number(x.poolLen) || 0;
      const laps = Number(x.laps) || 0;
      const minutes = Number(x.minutes) || 0;

      const tm = Number(x.totalMeters);
      const totalMeters = (Number.isFinite(tm) && tm > 0) ? tm : meters(laps, poolLen);

      return {
        id: x.id || (Math.random().toString(16).slice(2) + Date.now().toString(16)),
        date: (x.date || "").toString(),
        poolLen,
        laps,
        minutes,
        totalMeters,
        note: (x.note || "").toString()
      };
    }

    function load(){
      try {
        const raw = localStorage.getItem(ACTIVE_KEY) || "[]";
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr.map(normalizeSession);
      } catch {
        return [];
      }
    }

    function save(data){
      localStorage.setItem(ACTIVE_KEY, JSON.stringify(data));
    }

    function uuid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function addSession(){
      setMsg("", "");
      const date = $("date").value || todayISO();
      const poolLen = Number($("poolLen").value);
      const laps = Number($("laps").value);
      const minutes = Number($("minutes").value);
      const note = ($("note").value || "").trim();

      if (!poolLen || poolLen <= 0) return setMsg("üëâ Indique la taille d‚Äôune longueur (en m√®tres).");
      if (!Number.isFinite(laps) || laps < 0) return setMsg("üëâ Le nombre de longueurs doit √™tre ‚â• 0.");
      if (!minutes || minutes <= 0) return setMsg("üëâ Indique le temps de session (en minutes).");

      const totalMeters = meters(laps, poolLen);
      const session = { id: uuid(), date, poolLen, laps, minutes, totalMeters, note };

      const data = load().filter(s => s.poolLen > 0 && s.minutes > 0);
      data.push(session);
      save(data);

      setMsg("", "‚úÖ Session ajout√©e !");
      renderAll();
    }

    function clearInputs(){
      $("laps").value = "";
      $("minutes").value = "";
      $("note").value = "";
      setMsg("", "");
    }

    function exportJSON(){
      const data = load();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "sessions_piscine.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importJSON(){
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = async () => {
        const file = inp.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          const parsed = JSON.parse(text);
          if (!Array.isArray(parsed)) throw new Error("Format invalide (tableau attendu).");

          const clean = parsed
            .filter(x => x && typeof x === "object")
            .map(normalizeSession)
            .filter(s => s.poolLen > 0 && s.minutes > 0);

          save(clean);
          renderAll();
          setMsg("", "‚úÖ Import effectu√© !");
        } catch (e){
          setMsg("‚ùå Import impossible : " + (e?.message || e));
        }
      };
      inp.click();
    }

    function wipeAll(){
      if (!confirm("Tout effacer ? (irr√©versible)")) return;
      localStorage.removeItem(ACTIVE_KEY);
      renderAll();
      setMsg("", "‚úÖ Historique effac√©.");
    }

    function sortSessions(data){
      const mode = $("sort").value;
      const copy = [...data].filter(s => s.poolLen > 0 && s.minutes > 0);
      copy.sort((a,b) => {
        if (mode === "date_desc") return (b.date||"").localeCompare(a.date||"");
        if (mode === "date_asc") return (a.date||"").localeCompare(b.date||"");
        if (mode === "dist_desc") return (b.totalMeters||0) - (a.totalMeters||0);
        if (mode === "time_desc") return (b.minutes||0) - (a.minutes||0);
        if (mode === "pace_asc") {
          const pa = paceMinPer100m(a.totalMeters, a.minutes);
          const pb = paceMinPer100m(b.totalMeters, b.minutes);
          if (pa == null && pb == null) return 0;
          if (pa == null) return 1;
          if (pb == null) return -1;
          return pa - pb;
        }
        return 0;
      });
      return copy;
    }

    function renderSessions(){
      const data = load().filter(s => s.poolLen > 0 && s.minutes > 0);
      const sorted = sortSessions(data);

      const total = sorted.reduce((s,x)=>s+(x.totalMeters||0),0);
      $("countPill").textContent = `${sorted.length} session${sorted.length>1?"s":""}`;
      $("sumPill").textContent = `Total: ${total} m`;

      const tbody = $("tbody");
      tbody.innerHTML = "";

      for (const s of sorted){
        const pace = formatPace(paceMinPer100m(s.totalMeters, s.minutes));
        const details = `${s.laps} longueurs ¬∑ ${s.poolLen} m${s.note ? " ¬∑ " + s.note : ""}`;
        const kcal = kcalFromMinutes(s.minutes);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.date || "‚Äî"}</td>
          <td title="${details.replaceAll('"','&quot;')}">${details}</td>
          <td class="right">${s.totalMeters} m</td>
          <td class="right">${Number(s.minutes).toFixed(1)} min</td>
          <td class="right">${pace}</td>
          <td class="right">${kcal ? kcal.toFixed(0) : "‚Äî"}</td>
          <td class="right"></td>
        `;

        const btn = document.createElement("button");
        btn.textContent = "Supprimer";
        btn.className = "btn2";
        btn.style.width = "auto";
        btn.onclick = () => {
          save(load().filter(x => x.id !== s.id));
          renderAll();
        };
        tr.lastElementChild.appendChild(btn);

        tbody.appendChild(tr);
      }
    }

    function computeHistoryKpisAndRecords(){
      const data = load().map(normalizeSession).filter(s => s.poolLen > 0 && s.minutes > 0);
      save(data);

      const totalMeters = data.reduce((s,x)=>s+(Number(x.totalMeters)||0),0);
      const totalMinutes = data.reduce((s,x)=>s+(Number(x.minutes)||0),0);

      $("kDistance").textContent = totalMeters > 0 ? `${totalMeters} m` : "‚Äî";
      $("kDistance2").textContent = totalMeters > 0 ? `${(totalMeters/1000).toFixed(2)} km` : "";

      $("kTime").textContent = totalMinutes > 0 ? `${totalMinutes.toFixed(1)} min` : "‚Äî";
      $("kPace").textContent = formatPace(paceMinPer100m(totalMeters, totalMinutes));

      const sp = speedKmh(totalMeters, totalMinutes);
      $("kSpeed").textContent = sp == null ? "‚Äî" : sp.toFixed(2);

      const r = rateMPerMin(totalMeters, totalMinutes);
      $("kRate").textContent = r == null ? "‚Äî" : r.toFixed(1);

      const totalKcal = data.reduce((s,x)=>s + kcalFromMinutes(x.minutes), 0);
      $("kKcal").textContent = data.length ? `${totalKcal.toFixed(0)}` : "‚Äî";

      const dates = data.map(x=>x.date).filter(Boolean).sort();
      $("kPeriod").textContent = dates.length
        ? `P√©riode: ${dates[0]} ‚Üí ${dates[dates.length-1]} ‚Ä¢ ${data.length} sessions`
        : "Ajoute une session pour voir les stats.";

      if (!data.length){
        $("kRecDist").textContent = "‚Äî";
        $("kRecDist2").textContent = "";
        $("kRecPace").textContent = "‚Äî";
        $("kRecPace2").textContent = "";
        return;
      }

      const bestDist = data.reduce((m,x)=> !m || x.totalMeters > m.totalMeters ? x : m, null);
      $("kRecDist").textContent = `${bestDist.totalMeters} m`;
      $("kRecDist2").textContent = bestDist.date ? `le ${bestDist.date}` : "";

      const bestPace = data.reduce((m,x)=> {
        const p = paceMinPer100m(x.totalMeters, x.minutes);
        if (p == null) return m;
        if (!m) return x;
        const pm = paceMinPer100m(m.totalMeters, m.minutes);
        return (pm == null || p < pm) ? x : m;
      }, null);

      if (bestPace){
        $("kRecPace").textContent = formatPace(paceMinPer100m(bestPace.totalMeters, bestPace.minutes));
        $("kRecPace2").textContent = bestPace.date ? `le ${bestPace.date} ‚Ä¢ ${bestPace.totalMeters} m` : "";
      } else {
        $("kRecPace").textContent = "‚Äî";
        $("kRecPace2").textContent = "";
      }
    }

    function monthKey(iso){
      if (!iso || iso.length < 7) return "";
      return iso.slice(0,7);
    }

    function buildMonthlyStats(data){
      const map = new Map();
      for (const s of data){
        const mk = monthKey(s.date);
        if (!mk) continue;

        if (!map.has(mk)){
          map.set(mk, { month: mk, sessions: 0, totalMeters: 0, totalMinutes: 0, kcal: 0 });
        }
        const agg = map.get(mk);
        agg.sessions += 1;
        agg.totalMeters += Number(s.totalMeters) || 0;
        agg.totalMinutes += Number(s.minutes) || 0;
        agg.kcal += kcalFromMinutes(s.minutes);
      }
      return Array.from(map.values()).sort((a,b)=> (a.month||"").localeCompare(b.month||""));
    }

    function filterRange(arr){
      const v = $("chartRange").value;
      if (v === "all") return arr;
      const n = Number(v);
      if (!Number.isFinite(n) || n <= 0) return arr;
      return arr.slice(Math.max(0, arr.length - n));
    }

    function renderMonthlyTable(months){
      const tbody = $("tbodyMonths");
      tbody.innerHTML = "";

      if (!months.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="muted">Ajoute des sessions pour voir les stats mensuelles.</td>`;
        tbody.appendChild(tr);
        return;
      }

      for (const m of months){
        const pace = formatPace(paceMinPer100m(m.totalMeters, m.totalMinutes));
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.month}</td>
          <td class="right">${m.sessions}</td>
          <td class="right">${m.totalMeters} m <span class="muted">(${(m.totalMeters/1000).toFixed(2)} km)</span></td>
          <td class="right">${m.totalMinutes.toFixed(1)} min</td>
          <td class="right">${pace}</td>
          <td class="right">${m.kcal ? m.kcal.toFixed(0) : "‚Äî"}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function drawBarChart(canvas, labels, values){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.floor(canvas.clientWidth * dpr));
      canvas.height = Math.max(1, Math.floor(220 * dpr));

      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      const pad = 24 * dpr;
      const innerW = W - pad*2;
      const innerH = H - pad*2;

      const maxV = Math.max(1, ...values);
      const n = Math.max(1, values.length);
      const gap = innerW * 0.02;
      const barW = Math.max(2, (innerW - gap*(n-1)) / n);

      ctx.strokeStyle = "rgba(230,238,252,0.15)";
      ctx.lineWidth = 1 * dpr;
      ctx.beginPath();
      ctx.moveTo(pad, pad + innerH);
      ctx.lineTo(pad + innerW, pad + innerH);
      ctx.stroke();

      for (let i=0;i<n;i++){
        const v = values[i] || 0;
        const h = (v / maxV) * innerH;
        const x = pad + i*(barW+gap);
        const y = pad + (innerH - h);
        ctx.fillStyle = "rgba(79,124,255,0.85)";
        ctx.fillRect(x, y, barW, h);
      }

      ctx.fillStyle = "rgba(230,238,252,0.75)";
      ctx.font = `${11 * dpr}px system-ui`;
      const step = Math.ceil(n / 6);
      for (let i=0;i<n;i+=step){
        const text = labels[i] || "";
        const x = pad + i*(barW+gap);
        ctx.fillText(text, x, pad + innerH + (18 * dpr));
      }
    }

    function drawLineChart(canvas, labels, values){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.floor(canvas.clientWidth * dpr));
      canvas.height = Math.max(1, Math.floor(220 * dpr));

      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      const pad = 24 * dpr;
      const innerW = W - pad*2;
      const innerH = H - pad*2;

      const clean = values.map(v => (Number.isFinite(v) ? v : null));
      const finite = clean.filter(v => v != null);
      const maxV = finite.length ? Math.max(...finite) : 1;
      const minV = finite.length ? Math.min(...finite) : 0;

      const n = Math.max(1, values.length);

      ctx.strokeStyle = "rgba(230,238,252,0.15)";
      ctx.lineWidth = 1 * dpr;
      ctx.beginPath();
      ctx.moveTo(pad, pad + innerH);
      ctx.lineTo(pad + innerW, pad + innerH);
      ctx.stroke();

      ctx.strokeStyle = "rgba(79,124,255,0.95)";
      ctx.lineWidth = 2 * dpr;
      ctx.beginPath();

      let started = false;
      for (let i=0;i<n;i++){
        const v = clean[i];
        if (v == null) continue;
        const x = pad + (i/(n-1 || 1)) * innerW;
        const norm = (v - minV) / ((maxV - minV) || 1);
        const y = pad + (1 - norm) * innerH;
        if (!started){ ctx.moveTo(x,y); started = true; }
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      for (let i=0;i<n;i++){
        const v = clean[i];
        if (v == null) continue;
        const x = pad + (i/(n-1 || 1)) * innerW;
        const norm = (v - minV) / ((maxV - minV) || 1);
        const y = pad + (1 - norm) * innerH;
        ctx.fillStyle = "rgba(79,124,255,1)";
        ctx.beginPath();
        ctx.arc(x,y, 3*dpr, 0, Math.PI*2);
        ctx.fill();
      }

      ctx.fillStyle = "rgba(230,238,252,0.75)";
      ctx.font = `${11 * dpr}px system-ui`;
      const step = Math.ceil(n / 6);
      for (let i=0;i<n;i+=step){
        const text = labels[i] || "";
        const x = pad + (i/(n-1 || 1)) * innerW;
        ctx.fillText(text, x, pad + innerH + (18 * dpr));
      }
    }

    function renderMonthly(){
      const data = load().filter(s => s.poolLen > 0 && s.minutes > 0);
      const allMonths = buildMonthlyStats(data);
      const months = filterRange(allMonths);

      renderMonthlyTable(months);

      const labels = months.map(m => m.month.slice(5));
      const km = months.map(m => +(m.totalMeters/1000).toFixed(2));
      const paceVals = months.map(m => paceMinPer100m(m.totalMeters, m.totalMinutes));

      drawBarChart($("chartMonthly"), labels, km);
      drawLineChart($("chartPace"), labels, paceVals);

      if (!months.length){
        $("chartMonthlyNote").textContent = "Ajoute des sessions pour voir le graphique.";
        $("chartPaceNote").textContent = "";
      } else {
        const totalKm = km.reduce((s,v)=>s+v,0);
        $("chartMonthlyNote").textContent = `Total sur la p√©riode: ${totalKm.toFixed(2)} km`;
        const last = months[months.length-1];
        const lastPace = formatPace(paceMinPer100m(last.totalMeters, last.totalMinutes));
        $("chartPaceNote").textContent = `Dernier mois (${last.month}) : allure moy. ${lastPace}`;
      }
    }

    function forceUpdate(){
      ACTIVE_KEY = findActiveKey();
      $("activeKeyPill").textContent = `storage: ${ACTIVE_KEY}`;
      computeHistoryKpisAndRecords();
      renderMonthly();
      renderSessions();
      setMsg("", "‚úÖ Stats recalcul√©es (historique relu).");
      refreshUiSwBadges();
    }

    function renderAll(){
      $("activeKeyPill").textContent = `storage: ${ACTIVE_KEY}`;
      computeHistoryKpisAndRecords();
      renderMonthly();
      renderSessions();
    }

    // --- SW Debug: version SW active -> UI ---
    async function getSwVersion(){
      if (!navigator.serviceWorker?.controller) return null;

      return new Promise((resolve) => {
        const ch = new MessageChannel();
        ch.port1.onmessage = (e) => resolve(e.data);
        navigator.serviceWorker.controller.postMessage({ type: "GET_VERSION" }, [ch.port2]);
      });
    }

    async function refreshUiSwBadges(){
      const swPill = document.getElementById("uiSwBuild");
      const htmlPill = document.getElementById("uiHtmlBuild");
      const statePill = document.getElementById("uiSwState");

      const htmlBuild = window.a6e6a11 || document.documentElement.getAttribute("data-build") || "‚Äî";

      if (htmlPill) {
        htmlPill.textContent = `HTML: ${htmlBuild}`;
        htmlPill.className = "pill ok";
      }

      const info = await getSwVersion();
      if (!swPill) return;

      if (!info) {
        swPill.textContent = "SW actif: (aucun)";
        swPill.className = "pill warn";
        return;
      }

      swPill.textContent = `SW actif: ${info.build}`;
      swPill.className = "pill ok";

      if (htmlBuild !== "‚Äî" && info.build && info.build !== htmlBuild) {
        swPill.className = "pill warn";
        if (statePill) {
          statePill.style.display = "inline-block";
          statePill.textContent = "SW: mismatch (reload conseill√©)";
        }
      } else {
        if (statePill) statePill.style.display = "none";
      }
    }

    // Init
    ACTIVE_KEY = findActiveKey();
    $("date").value = todayISO();
    $("poolLen").value = 25;
    $("weightKg").value = 78;

    $("addBtn").addEventListener("click", addSession);
    $("forceBtn").addEventListener("click", forceUpdate);
    $("clearInputsBtn").addEventListener("click", clearInputs);
    $("exportBtn").addEventListener("click", exportJSON);
    $("importBtn").addEventListener("click", importJSON);
    $("wipeBtn").addEventListener("click", wipeAll);

    $("sort").addEventListener("change", renderSessions);
    $("chartRange").addEventListener("change", renderMonthly);

    $("weightKg").addEventListener("input", () => { renderAll(); refreshUiSwBadges(); });
    $("intensity").addEventListener("change", () => { renderAll(); refreshUiSwBadges(); });

    renderAll();
    refreshUiSwBadges();
    window.addEventListener("resize", renderMonthly);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        refreshUiSwBadges();
      });
    }
  </script>

  <!-- =========================
       SW REGISTER + AUTO UPDATE
  ========================== -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          const reg = await navigator.serviceWorker.register("./sw.js");

          // badge "update‚Ä¶" quand un nouveau SW est d√©tect√©
          reg.addEventListener("updatefound", () => {
            const p = document.getElementById("uiSwState");
            if (p) { p.style.display = "inline-block"; p.textContent = "SW: update‚Ä¶"; }
          });

          // force activation du nouveau SW
          reg.addEventListener("updatefound", () => {
            const newWorker = reg.installing;
            if (!newWorker) return;

            newWorker.addEventListener("statechange", () => {
              if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
                newWorker.postMessage({ type: "SKIP_WAITING" });
              }
            });
          });

          // quand le nouveau SW prend le contr√¥le -> reload
          navigator.serviceWorker.addEventListener("controllerchange", () => {
            window.location.reload();
          });

        } catch (e) {
          console.log("SW register failed", e);
        }
      });
    }
  </script>
</body>
</html>
